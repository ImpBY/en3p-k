###############################################################################################################################################################################
# PID Calibration Macros
###############################################################################################################################################################################

# Calibrate PID: https://www.klipper3d.org/Config_checks.html#calibrate-pid-settings
# Usage: 
#   PID_Hotend TEMP=220
#   PID_Bed TEMP=80

[gcode_macro PID_Hotend]
description: "Calibrate PID for hotend. Usage: PID_Hotend TEMP=220"
gcode:
  {% set target_temp = params.TEMP|default(220)|float %}

  # Safety check - validate temperature range
  {% if target_temp < 150 or target_temp > 300 %}
    {action_respond_info("ERROR: Hotend temperature must be between 150-300°C")}
    {action_raise_error("Invalid temperature range")}
  {% endif %}

  {action_respond_info("Starting PID calibration for hotend at %.0f°C" % target_temp)}
  {action_respond_info("This will take approximately 5 minutes...")}

  # Ensure part cooling fan is off
  M107

  # Run PID calibration
  PID_CALIBRATE HEATER=extruder TARGET={target_temp}

  # Turn off fan (safety)
  M107

  # Cool down hotend
  M104 S0

  {action_respond_info("PID calibration complete!")}
  {action_respond_info("Results:")}
  {action_respond_info("  pid_Kp = %.3f" % printer.configfile.settings.extruder.pid_kp)}
  {action_respond_info("  pid_Ki = %.3f" % printer.configfile.settings.extruder.pid_ki)}
  {action_respond_info("  pid_Kd = %.3f" % printer.configfile.settings.extruder.pid_kd)}
  {action_respond_info("Run SAVE_CONFIG to save these values.")}


[gcode_macro PID_Bed]
description: "Calibrate PID for heated bed. Usage: PID_Bed TEMP=80"
gcode:
  {% set target_temp = params.TEMP|default(80)|float %}

  # Safety check - validate temperature range
  {% if target_temp < 40 or target_temp > 110 %}
    {action_respond_info("ERROR: Bed temperature must be between 40-110°C")}
    {action_raise_error("Invalid temperature range")}
  {% endif %}

  {action_respond_info("Starting PID calibration for bed at %.0f°C" % target_temp)}
  {action_respond_info("This will take approximately 10 minutes...")}

  # Home and center nozzle over bed for uniform heat distribution
  G28
  G90
  {% set center_x = printer.toolhead.axis_maximum.x / 2 %}
  {% set center_y = printer.toolhead.axis_maximum.y / 2 %}
  G1 X{center_x} Y{center_y} Z50 F3000

  # Ensure part cooling fan is off
  M107

  # Run PID calibration
  PID_CALIBRATE HEATER=heater_bed TARGET={target_temp}

  # Turn off fan (safety)
  M107

  # Cool down bed
  M140 S0

  {action_respond_info("PID calibration complete!")}
  {action_respond_info("Results:")}
  {action_respond_info("  pid_Kp = %.3f" % printer.configfile.settings.heater_bed.pid_kp)}
  {action_respond_info("  pid_Ki = %.3f" % printer.configfile.settings.heater_bed.pid_ki)}
  {action_respond_info("  pid_Kd = %.3f" % printer.configfile.settings.heater_bed.pid_kd)}
  {action_respond_info("Run SAVE_CONFIG to save these values.")}


# Quick PID calibration for common temperatures
[gcode_macro PID_Quick]
description: "Quick PID calibration for common materials. Usage: PID_Quick MATERIAL=PLA"
gcode:
  {% set material = params.MATERIAL|default("PLA")|upper %}

  {% if material == "PLA" %}
    {action_respond_info("Calibrating for PLA (Hotend: 210°C, Bed: 60°C)")}
    PID_Hotend TEMP=210
    G4 P60000  # Wait 1 minute for cooldown
    PID_Bed TEMP=60
  {% elif material == "PETG" %}
    {action_respond_info("Calibrating for PETG (Hotend: 240°C, Bed: 80°C)")}
    PID_Hotend TEMP=240
    G4 P60000
    PID_Bed TEMP=80
  {% elif material == "ABS" %}
    {action_respond_info("Calibrating for ABS (Hotend: 250°C, Bed: 100°C)")}
    PID_Hotend TEMP=250
    G4 P60000
    PID_Bed TEMP=100
  {% else %}
    {action_respond_info("ERROR: Unknown material. Use: PLA, PETG, or ABS")}
    {action_raise_error("Invalid material")}
  {% endif %}
