# Most of specific things for Neptune 3/Neptune Pro are listed there, make sure you follow the guide on setting up Eddy at https://github.com/bigtreetech/eddy

[mcu eddy]
serial: /dev/serial/by-id/usb-Klipper_rp2040_5044506128C0751C-if00
restart_method: command
# is_non_critical: true

[temperature_sensor eddy_mcu]
sensor_type: temperature_mcu
sensor_mcu: eddy
min_temp: 0
max_temp: 100 

[temperature_probe eddy]
sensor_type: Generic 3950
sensor_pin: eddy:gpio26

[probe_eddy_current eddy]
sensor_type: ldc1612
i2c_mcu: eddy
i2c_bus: i2c0f
x_offset: -34.20
y_offset: 24.15
# z_offset: 4.0
speed: 5.0
lift_speed: 10.0
samples: 1
sample_retract_dist: 2.0
samples_result: median
samples_tolerance: 0.005
samples_tolerance_retries: 5

[bed_mesh]
horizontal_move_z: 1.0 # Very important, TheFeralEngineer's value of 5 will not work
mesh_min: 15,26 # Important
mesh_max: 195,215 # Important
probe_count: 17, 17
algorithm: bicubic
speed: 100
fade_start: 0.4
fade_end: 1.0
fade_target: 0.0
split_delta_z: 0.01
zero_reference_position: 115, 115
# zero_reference_position: 149.25, 89.5
adaptive_margin: 0
scan_overshoot: 1

[safe_z_home]
# home_xy_position: 115, 115
home_xy_position: 149.25, 89.5
move_to_previous: False
z_hop: 6.0
z_hop_speed: 5.0

[force_move]
enable_force_move: True

### calibrate

[gcode_macro EDDY_CALIBRATE_CURRENT]
description: "Calibrate Eddy drive current. Follow on-screen instructions."
gcode:
  {action_respond_info("=== EDDY DRIVE CURRENT CALIBRATION ===")}

  SET_VELOCITY_LIMIT VELOCITY=100 ACCEL=600
  BED_MESH_CLEAR

  # Home X and Y only
  {action_respond_info("Homing X and Y axes...")}
  G28 X Y

  # Move to center of bed
  G90
  {% set center_x = printer.toolhead.axis_maximum.x / 2 %}
  {% set center_y = printer.toolhead.axis_maximum.y / 2 %}
  G1 X{center_x} Y{center_y} F6000

  {% if 'z' not in printer.toolhead.homed_axes %}
    {action_respond_info("=== MANUAL CALIBRATION REQUIRED ===")}
    {action_respond_info("STEP 1: Use web interface to jog Z axis")}
    {action_respond_info("STEP 2: Lower Z until Eddy probe is ~1mm from bed")}
    {action_respond_info("STEP 3: Run command: LDC_CALIBRATE_DRIVE_CURRENT CHIP=eddy")}
    {action_respond_info("STEP 4: After calibration, run: SAVE_CONFIG")}
    {action_respond_info("===================================")}
  {% else %}
    # If Z is homed, move to safe height
    {action_respond_info("Z axis is homed. Moving to safe height...")}
    G1 Z20 F600
    {action_respond_info("=== MANUAL CALIBRATION REQUIRED ===")}
    {action_respond_info("STEP 1: Lower Z until probe is ~1mm from bed")}
    {action_respond_info("STEP 2: Run: LDC_CALIBRATE_DRIVE_CURRENT CHIP=eddy")}
    {action_respond_info("STEP 3: Run: SAVE_CONFIG")}
    {action_respond_info("===================================")}
  {% endif %}

  SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel}


[gcode_macro EDDY_CALIBRATE_PROBE]
description: "Calibrate Eddy probe Z offset. Requires homed Z axis."
gcode:
  {action_respond_info("Starting Eddy probe calibration...")}

  SET_VELOCITY_LIMIT VELOCITY=100 ACCEL=600
  BED_MESH_CLEAR

  # Require Z to be homed first
  {% if 'z' not in printer.toolhead.homed_axes %}
    {action_respond_info("ERROR: Z axis must be homed first!")}
    {action_respond_info("Run G28 or EDDY_CALIBRATE_CURRENT first")}
    {action_raise_error("Z axis not homed")}
  {% endif %}

  # Home X and Y
  G28 X Y

  # Move to center of bed
  G90
  G1 X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_maximum.y/2} F6000

  # Move to safe height first
  G1 Z10 F600

  {action_respond_info("Starting probe calibration...")}
  PROBE_EDDY_CURRENT_CALIBRATE CHIP=eddy

  SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel}


[gcode_macro EDDY_CALIBRATE_DRIFT]
description: "Calibrate Eddy temperature drift compensation. Takes ~30 minutes."
gcode:
  {action_respond_info("=== EDDY TEMPERATURE DRIFT CALIBRATION ===")}
  {action_respond_info("This process will take approximately 30 minutes")}
  {action_respond_info("The probe will heat from ambient to 56°C in 2°C steps")}
  {action_respond_info("==========================================")}

  SET_VELOCITY_LIMIT VELOCITY=100 ACCEL=600
  BED_MESH_CLEAR

  # Home all axes
  {action_respond_info("Homing all axes...")}
  G28

  # Optional: Heat bed and extruder for realistic conditions
  # Uncomment if you want to calibrate with heated bed/extruder
  # {action_respond_info("Heating bed to 60°C and extruder to 200°C...")}
  # SET_HEATER_TEMPERATURE HEATER=extruder TARGET=200
  # SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=60
  # TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM=60
  # TEMPERATURE_WAIT SENSOR=extruder MINIMUM=200

  # Move to center and lower to measurement height
  {% set center_x = printer.toolhead.axis_maximum.x / 2 %}
  {% set center_y = printer.toolhead.axis_maximum.y / 2 %}
  G1 X{center_x} Y{center_y} F6000
  G1 Z1 F600

  {action_respond_info("Starting temperature calibration...")}
  {action_respond_info("Current probe temp: %.1f°C" % printer['temperature_probe eddy'].temperature)}
  {action_respond_info("Target: 56°C in 2°C steps")}

  TEMPERATURE_PROBE_CALIBRATE PROBE=eddy TARGET=60 STEP=2

  {action_respond_info("==========================================")}
  {action_respond_info("Drift calibration started!")}
  {action_respond_info("Monitor progress in console")}
  {action_respond_info("==========================================")}


[gcode_macro EDDY_CALIBRATE_DRIFT_NEXT]
description: "Continue to next temperature step in drift calibration"
gcode:
  {% if printer['temperature_probe eddy'] %}
    {action_respond_info("Current probe temperature: %.1f°C" % printer['temperature_probe eddy'].temperature)}
    {action_respond_info("Continuing to next temperature step...")}
  {% endif %}

  TEMPERATURE_PROBE_NEXT

  {action_respond_info("Waiting for temperature stabilization...")}
  {action_respond_info("This may take several minutes per step")}


[gcode_macro EDDY_CALIBRATE_DRIFT_STOP]
description: "Complete and save drift calibration"
gcode:
  {action_respond_info("=== COMPLETING DRIFT CALIBRATION ===")}

  # Complete calibration
  TEMPERATURE_PROBE_COMPLETE

  {action_respond_info("Drift calibration completed!")}
  {action_respond_info("Shutting down heaters and motors...")}

  # Turn off heaters
  M140 S0  # Turn off bed heater
  M104 S0  # Turn off extruder heater

  # Turn off fan
  M107

  # Wait a moment for heaters to start cooling
  G4 P2000

  # Turn off motors
  M84

  {action_respond_info("==========================================")}
  {action_respond_info("IMPORTANT: Run SAVE_CONFIG to save calibration!")}
  {action_respond_info("After restart, your Eddy will be fully calibrated")}
  {action_respond_info("==========================================")}


# Uncomment this if you are using Eddy as the probe AND the homing endstop AND would like to use the beta z-offset control
[delayed_gcode RESTORE_PROBE_OFFSET]
initial_duration: 1.
gcode:
 {% set svv = printer.save_variables.variables %}
 {% if not printer["gcode_macro SET_GCODE_OFFSET"].restored %}
   SET_GCODE_VARIABLE MACRO=SET_GCODE_OFFSET VARIABLE=runtime_offset VALUE={ svv.nvm_offset|default(0) }
   SET_GCODE_VARIABLE MACRO=SET_GCODE_OFFSET VARIABLE=restored VALUE=True
 {% endif %}


# Uncomment this if you are using Eddy as the probe AND the homing endstop
[gcode_macro G28]
rename_existing: G28.1
gcode:
  {% set home_all = not rawparams %}
  {% set home_z = 'Z' in rawparams %}

  # Home axes
  G28.1 {rawparams}

  # If homing Z (or all), probe and set Z from probe
  {% if home_all or home_z %}
    {action_respond_info("Probing Z with Eddy...")}
    PROBE
    SET_Z_FROM_PROBE
    {action_respond_info("Z homing complete")}
  {% endif %}


# Uncomment this if you are using Eddy as the probe AND the homing endstop
[gcode_macro SET_Z_FROM_PROBE]
gcode:
  {% set cf = printer.configfile.settings %}
  {% set probe_cfg = cf['probe_eddy_current eddy'] %}
  {% set runtime_offset = printer["gcode_macro SET_GCODE_OFFSET"].runtime_offset %}

  {% set z_offset = printer.probe.last_z_result - probe_cfg.z_offset %}
  {% set z_offset = z_offset + runtime_offset %}

  {action_respond_info("  X Offset: %.2fmm" % probe_cfg.x_offset)}
  {action_respond_info("  Y Offset: %.2fmm" % probe_cfg.y_offset)}
  {% if probe_cfg.z_offset %}
    {action_respond_info("  Z Offset: %.3fmm" % probe_cfg.z_offset)}
  {% else %}
    {action_respond_info("  ⚠ Z Offset: NOT CALIBRATED")}
  {% endif %}
  {action_respond_info("  runtime Z Offset: %.3fmm" % runtime_offset)}
  {action_respond_info("  result Z Offset: %.3fmm" % z_offset)}

  SET_GCODE_OFFSET_ORIG Z={z_offset}
  G90
  G1 Z{cf.safe_z_home.z_hop} F600
  # G91
  # G1 X{probe_cfg.x_offset} Y{probe_cfg.y_offset} F3000


# Uncomment this if you are using Eddy as the probe AND the homing endstop AND would like to use the beta z-offset control
[gcode_macro Z_OFFSET_APPLY_PROBE]
rename_existing: Z_OFFSET_APPLY_PROBE_ORIG
gcode:
  SAVE_VARIABLE VARIABLE=nvm_offset VALUE={ printer["gcode_macro SET_GCODE_OFFSET"].runtime_offset }


# Uncomment the lines in this macro if you are using Eddy as the probe AND the homing endstop AND would like to use the beta z-offset control
[gcode_macro SET_GCODE_OFFSET]
rename_existing: SET_GCODE_OFFSET_ORIG
variable_restored: False  # Mark whether the var has been restored from NVM
variable_runtime_offset: 0
gcode:
  {% if params.Z_ADJUST %}
    SET_GCODE_VARIABLE MACRO=SET_GCODE_OFFSET VARIABLE=runtime_offset VALUE={ printer["gcode_macro SET_GCODE_OFFSET"].runtime_offset + params.Z_ADJUST|float }
  {% endif %}
  {% if params.Z %}
    {% set paramList = rawparams.split() %}
    {% for i in range(paramList|length) %}
      {% if paramList[i]=="Z=0" %}
        {% set temp=paramList.pop(i) %}
        {% set temp="Z_ADJUST=" + (-printer["gcode_macro SET_GCODE_OFFSET"].runtime_offset)|string %}
        {% if paramList.append(temp) %}{% endif %}
      {% endif %}
    {% endfor %}
    {% set rawparams=paramList|join(' ') %}
    SET_GCODE_VARIABLE MACRO=SET_GCODE_OFFSET VARIABLE=runtime_offset VALUE=0
  {% endif %}
  SET_GCODE_OFFSET_ORIG { rawparams }


[gcode_macro BED_MESH_CALIBRATE]
rename_existing: BTT_BED_MESH_CALIBRATE
description: "Calibrate bed mesh. Usage: BED_MESH_CALIBRATE [ADAPTIVE=1] [PROFILE=name]"
gcode:
  {% set adaptive = params.ADAPTIVE|default(1)|int %}
  {% set method = params.METHOD|default('rapid_scan') %}

  {action_respond_info("Starting bed mesh calibration (adaptive=%s, method=%s)..." % (adaptive, method))}

  # Reduce velocity for mesh calibration
  SET_VELOCITY_LIMIT VELOCITY=100 ACCEL=600

  # Home if not already homed
  {% if "xyz" not in printer.toolhead.homed_axes %}
    {action_respond_info("Homing all axes...")}
    G28
  {% else %}
    {action_respond_info("Printer already homed, skipping G28")}
  {% endif %}

  # Run mesh calibration with user parameters
  {% if adaptive == 1 %}
    {action_respond_info("Running ADAPTIVE mesh calibration...")}
    BTT_BED_MESH_CALIBRATE METHOD={method} ADAPTIVE=1 {rawparams}
  {% else %}
    {action_respond_info("Running FULL mesh calibration...")}
    BTT_BED_MESH_CALIBRATE METHOD={method} {rawparams}
  {% endif %}

  # Restore velocity limits
  SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel}

  {action_respond_info("Bed mesh calibration complete!")}

[gcode_macro EDDY_CALIBRATE_ALL]
description: "Complete Eddy calibration sequence (interactive guide)"
gcode:
  {action_respond_info("╔════════════════════════════════════════════╗")}
  {action_respond_info("║  EDDY COMPLETE CALIBRATION SEQUENCE       ║")}
  {action_respond_info("╚════════════════════════════════════════════╝")}
  {action_respond_info("")}
  {action_respond_info("This wizard will guide you through all calibration steps:")}
  {action_respond_info("  1. Drive Current Calibration (~5 minutes)")}
  {action_respond_info("  2. Z Offset Calibration (~5 minutes)")}
  {action_respond_info("  3. Temperature Drift Calibration (~30 minutes)")}
  {action_respond_info("")}
  {action_respond_info("Total time: ~40 minutes")}
  {action_respond_info("═══════════════════════════════════════════════")}
  {action_respond_info("")}

  # Check if Eddy is connected
  {% if 'probe_eddy_current eddy' not in printer %}
    {action_respond_info("ERROR: Eddy MCU not connected!")}
    {action_respond_info("Check USB connection and restart Klipper")}
    {action_raise_error("Eddy MCU not found")}
  {% endif %}

  {action_respond_info("┌─────────────────────────────────────────────┐")}
  {action_respond_info("│ STEP 1/3: DRIVE CURRENT CALIBRATION        │")}
  {action_respond_info("└─────────────────────────────────────────────┘")}
  {action_respond_info("")}

  EDDY_CALIBRATE_CURRENT

  {action_respond_info("")}
  {action_respond_info("═══════════════════════════════════════════════")}
  {action_respond_info("NEXT STEPS:")}
  {action_respond_info("  1. Complete the drive current calibration above")}
  {action_respond_info("  2. Run: SAVE_CONFIG")}
  {action_respond_info("  3. After Klipper restarts, run: EDDY_CALIBRATE_PROBE")}
  {action_respond_info("  4. Then run: SAVE_CONFIG again")}
  {action_respond_info("  5. After restart, run: EDDY_CALIBRATE_DRIFT")}
  {action_respond_info("  6. Finally run: SAVE_CONFIG one last time")}
  {action_respond_info("═══════════════════════════════════════════════")}

[gcode_macro EDDY_STATUS]
description: "Display Eddy probe status and calibration info"
gcode:
  {action_respond_info("=== EDDY PROBE STATUS ===")}

  # Check if Eddy MCU is connected
  {% if 'probe_eddy_current eddy' in printer %}
    {action_respond_info("✓ Eddy MCU: Connected")}

    # Temperature sensor status
    {% if 'temperature_sensor eddy_mcu' in printer %}
      {action_respond_info("  MCU Temperature: %.1f°C" % printer['temperature_sensor eddy_mcu'].temperature)}
    {% endif %}

    # Probe temperature
    {% if 'temperature_probe eddy' in printer %}
      {action_respond_info("  Probe Temperature: %.1f°C" % printer['temperature_probe eddy'].temperature)}
    {% endif %}

    # Probe configuration
    {% if 'probe_eddy_current eddy' in printer.configfile.settings %}
      {% set probe_cfg = printer.configfile.settings['probe_eddy_current eddy'] %}
      {action_respond_info("  X Offset: %.2fmm" % probe_cfg.x_offset)}
      {action_respond_info("  Y Offset: %.2fmm" % probe_cfg.y_offset)}
      {% if probe_cfg.z_offset %}
        {action_respond_info("  Z Offset: %.3fmm" % probe_cfg.z_offset)}
      {% else %}
        {action_respond_info("  ⚠ Z Offset: NOT CALIBRATED")}
      {% endif %}
      {action_respond_info("  Speed: %.1fmm/s" % probe_cfg.speed)}
      {action_respond_info("  Lift Speed: %.1fmm/s" % probe_cfg.lift_speed)}
    {% endif %}

    # Last probe result
    {% if printer.probe.last_z_result %}
      {action_respond_info("  Last Probe Result: %.3fmm" % printer.probe.last_z_result)}
    {% endif %}

    # Runtime Z offset
    {% if printer["gcode_macro SET_GCODE_OFFSET"] %}
      {action_respond_info("  Runtime Z Offset: %.3fmm" % printer["gcode_macro SET_GCODE_OFFSET"].runtime_offset)}
    {% endif %}

  {% else %}
    {action_respond_info("✗ Eddy MCU: NOT CONNECTED")}
    {action_respond_info("  Check USB connection and serial port")}
  {% endif %}

  {action_respond_info("=========================")}

[gcode_macro EDDY_TEST_PROBE]
description: "Quick test of Eddy probe functionality"
gcode:
  {action_respond_info("=== EDDY PROBE TEST ===")}

  # Check if probe is configured
  {% if 'probe_eddy_current eddy' not in printer.configfile.settings %}
    {action_respond_info("ERROR: Eddy probe not configured!")}
    {action_raise_error("Eddy probe not found in configuration")}
  {% endif %}

  # Check Z offset calibration
  {% set probe_cfg = printer.configfile.settings['probe_eddy_current eddy'] %}
  {% if not probe_cfg.z_offset %}
    {action_respond_info("WARNING: Z offset not calibrated!")}
    {action_respond_info("Run EDDY_CALIBRATE_PROBE first")}
  {% endif %}

  # Home if needed
  {% if "xyz" not in printer.toolhead.homed_axes %}
    {action_respond_info("Homing all axes...")}
    G28
  {% endif %}

  # Move to center
  {% set center_x = printer.toolhead.axis_maximum.x / 2 %}
  {% set center_y = printer.toolhead.axis_maximum.y / 2 %}

  {action_respond_info("Moving to bed center...")}
  G90
  G1 X{center_x} Y{center_y} Z10 F6000

  # Perform test probes
  {action_respond_info("Performing 5 test probes...")}

  PROBE_ACCURACY SAMPLES=5

  {action_respond_info("=== TEST COMPLETE ===")}
  {action_respond_info("Check probe accuracy results above")}
  {action_respond_info("Standard deviation should be < 0.010mm")}
  {action_respond_info("======================")}

