###############################################################################################################################################################################
# NOZZLE CLEANING
###############################################################################################################################################################################

[gcode_macro CLEAN_NOZZLE_BRUSH]
description: "Clean nozzle using brush. Usage: CLEAN_NOZZLE_BRUSH EXTRUDER_TEMP=170 BRUSH_Z=0.5"
gcode:
  {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(170)|float %}
  {% set BRUSH_Z_HEIGHT = params.BRUSH_Z|default(0.5)|float %}
  {% set BRUSH_X_START = -3.0 %}  # Safe X position for brush
  {% set BRUSH_Y_CENTER = 50 %}
  {% set BRUSH_Y_RANGE = 48 %}    # +/- range from center

  # Safety checks
  {% if EXTRUDER_TEMP < 150 or EXTRUDER_TEMP > 300 %}
    {action_respond_info("ERROR: Temperature must be between 150-300°C")}
    {action_raise_error("Invalid temperature")}
  {% endif %}

  {% if BRUSH_Z_HEIGHT < 0.2 or BRUSH_Z_HEIGHT > 5.0 %}
    {action_respond_info("ERROR: Brush Z height must be between 0.2-5.0mm")}
    {action_raise_error("Invalid brush height")}
  {% endif %}

  {action_respond_info("Starting nozzle cleaning at %.0f°C..." % EXTRUDER_TEMP)}

  # Save current state
  SAVE_GCODE_STATE NAME=CLEAN_NOZZLE_STATE

  # Home all axes
  G28

  # Move to safe position above brush area
  G90                     
  G1 Z10 F3000              # Raise to safe height
  G1 X0 Y{BRUSH_Y_CENTER} F7800  # Move to brush area

  # Heat extruder if needed
  {% if printer.extruder.temperature < EXTRUDER_TEMP %}
    {action_respond_info("Heating extruder to %.0f°C..." % EXTRUDER_TEMP)}
    M109 S{EXTRUDER_TEMP}
  {% endif %}

  # Purge filament before cleaning
  G91                       # Relative positioning
  G92 E0                    # Reset extruder
  G1 E3 F60                 # Extrude 3mm slowly
  G4 P1000                  # Wait 1 second
  G1 E-1 F2000              # Retract 1mm
  G90                       # Absolute positioning

  # Turn on part cooling fan slightly
  M106 S26

  # Move to brush start position
  G1 X{BRUSH_X_START} Y{BRUSH_Y_CENTER} F6000

  # Lower to brush contact height
  G1 Z{BRUSH_Z_HEIGHT} F1200

  {action_respond_info("Cleaning nozzle...")}

  # Cleaning pattern - zigzag motion with X offset
  # Pass 1-2: Slow cleaning
  G91  # Relative mode for cleaning pattern
  G1 X0.3 Y-{BRUSH_Y_RANGE} F3000   # Move down-right
  G1 X-0.6 Y{BRUSH_Y_RANGE} F3000   # Move up-left
  G1 X0.6 Y-{BRUSH_Y_RANGE} F3000   # Move down-right
  G1 X-0.3 Y{BRUSH_Y_RANGE} F3000   # Move up-left

  # Pass 3-4: Medium speed
  G1 X0.3 Y-{BRUSH_Y_RANGE} F4000
  G1 X-0.6 Y{BRUSH_Y_RANGE} F4000
  G1 X0.6 Y-{BRUSH_Y_RANGE} F4000
  G1 X-0.3 Y{BRUSH_Y_RANGE} F4000

  # Pass 5-6: Fast cleaning
  G1 X0.3 Y-{BRUSH_Y_RANGE} F5000
  G1 X-0.6 Y{BRUSH_Y_RANGE} F5000
  G1 X0.6 Y-{BRUSH_Y_RANGE} F5000
  G1 X-0.3 Y{BRUSH_Y_RANGE} F5000

  G90  # Return to absolute positioning

  # Raise nozzle after cleaning
  G1 Z5 F3000

  # Turn off part cooling fan
  M106 S0

  # Move to safe position
  G1 X0 Y{BRUSH_Y_CENTER}
